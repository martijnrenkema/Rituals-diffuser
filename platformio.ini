; PlatformIO Project Configuration File
; Rituals Perfume Genie 2.0 - Custom Firmware

; ===========================================
; Native Test Environment (runs on PC)
; ===========================================
[env:native]
platform = native
platform_packages =
    toolchain-gccmingw32
test_framework = unity
test_filter = test_native
build_flags =
    -std=c++11

; ===========================================
; ESP8266 Test Environment (runs on device)
; ===========================================
[env:esp8266_test]
platform = espressif8266@4.2.1
board = esp_wroom_02
framework = arduino
test_framework = unity
test_filter = test_embedded

; Only compile LED-related source files for testing
build_src_filter =
    +<led_controller.cpp>
    +<led_controller.h>
    +<ws2812_minimal.h>
    +<config.h>

lib_deps =

lib_ignore =
    FastLED
    ESP8266SdFat
    SD
    SDFS
    PubSubClient
    ArduinoJson
    ESPAsyncWebServer
    ESPAsyncTCP
    MFRC522

board_build.filesystem = littlefs
board_build.ldscript = eagle.flash.2m128.ld
monitor_speed = 115200
upload_speed = 115200
build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DPIO_FRAMEWORK_ARDUINO_LWIP2_LOW_MEMORY_LOW_FLASH
    -DVTABLES_IN_FLASH
    -DNDEBUG
    -fno-exceptions
    -fno-rtti
    -Os

[env:esp8266]
; Latest platform with GCC 10.3 (C++17 support)
platform = espressif8266@4.2.1
board = esp_wroom_02
framework = arduino

; Libraries - ESP8266 uses minimal WS2812 driver
lib_deps =
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^6.21
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/ESPAsyncTCP@^1.2.2
    miguelbalboa/MFRC522@^1.4.10

; LittleFS for web files (more efficient than SPIFFS)
board_build.filesystem = littlefs
board_build.ldscript = eagle.flash.2m128.ld

; Serial monitor
monitor_speed = 115200

; Upload settings - Serial (eerste keer)
upload_speed = 115200
; upload_port = /dev/cu.usbserial-0001

; Build flags - aggressive size optimization
build_flags =
    -DCORE_DEBUG_LEVEL=0
    ; ASYNCWEBSERVER_REGEX removed - saves ~20KB Flash, ~1KB RAM (not using regex routes)
    ; Network stack - LOW_MEMORY_LOW_FLASH uses smallest TCP buffers + no LWIP features - saves 86 bytes ram and 10268 bytes flash
    -DPIO_FRAMEWORK_ARDUINO_LWIP2_LOW_MEMORY_LOW_FLASH
    ; Disable debug/assertions - saves 372 bytes ram and 4024 bytes flash
    -DNDEBUG

; ===========================================
; ESP32 Environment (voor als ESP8266 kapot is)
; ===========================================
[env:esp32dev]
platform = espressif32@6.12.0
board = esp32dev
framework = arduino

lib_deps =
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^6.21
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    fastled/FastLED@^3.6.0
    miguelbalboa/MFRC522@^1.4.10

; SPIFFS for web files
board_build.filesystem = spiffs
; Use min_spiffs partition: 1.9MB app, 190KB SPIFFS (default is 1.3MB app)
board_build.partitions = min_spiffs.csv

; Serial monitor
monitor_speed = 115200

; Upload settings
upload_speed = 921600

; Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DASYNCWEBSERVER_REGEX

; ESP32 OTA environment
[env:esp32_ota]
platform = espressif32@6.12.0
board = esp32dev
framework = arduino

lib_deps =
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^6.21
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    fastled/FastLED@^3.6.0
    miguelbalboa/MFRC522@^1.4.10

board_build.filesystem = spiffs
; Use min_spiffs partition: 1.9MB app, 190KB SPIFFS
board_build.partitions = min_spiffs.csv
monitor_speed = 115200

upload_protocol = espota
upload_port = rituals-diffuser.local
upload_flags =
    --auth=diffuser-ota

build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DASYNCWEBSERVER_REGEX

; ===========================================
; ESP32-C3 SuperMini Environment
; ===========================================
[env:esp32c3_supermini]
platform = espressif32@6.12.0
board = esp32-c3-devkitm-1
framework = arduino

lib_deps =
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^6.21
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    fastled/FastLED@^3.6.0
    miguelbalboa/MFRC522@^1.4.10

; SPIFFS for web files
board_build.filesystem = spiffs
board_build.partitions = min_spiffs.csv

; Serial monitor
monitor_speed = 115200

; Upload settings
upload_speed = 921600

; Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DASYNCWEBSERVER_REGEX
    -DESP32C3_SUPERMINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; ===========================================
; ESP32-C3 SuperMini RC522 TEST Environment
; ===========================================
[env:esp32c3_rfid_test]
platform = espressif32@6.12.0
board = esp32-c3-devkitm-1
framework = arduino

; Only compile the RC522 test file
src_filter = +<rc522_test.cpp>

lib_deps =
    miguelbalboa/MFRC522@^1.4.10

; Serial monitor
monitor_speed = 115200

; Upload settings
upload_speed = 921600

; Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -DESP32C3_SUPERMINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DRC522_TEST_MODE

; ===========================================
; ESP32-C3 SuperMini RC522 PIN SCANNER
; ===========================================
[env:esp32c3_rfid_scan]
platform = espressif32@6.12.0
board = esp32-c3-devkitm-1
framework = arduino

; Only compile the RC522 scan file
build_src_filter = +<rc522_scan.cpp>

lib_deps =
    miguelbalboa/MFRC522@^1.4.10

; Serial monitor
monitor_speed = 115200

; Upload settings
upload_speed = 921600

; Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -DESP32C3_SUPERMINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DRC522_SCAN_MODE

; ESP32-C3 SuperMini OTA environment
[env:esp32c3_ota]
platform = espressif32@6.12.0
board = esp32-c3-devkitm-1
framework = arduino

lib_deps =
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^6.21
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    fastled/FastLED@^3.6.0

board_build.filesystem = spiffs
board_build.partitions = min_spiffs.csv
monitor_speed = 115200

upload_protocol = espota
upload_port = rituals-diffuser.local
upload_flags =
    --auth=diffuser-ota

build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DASYNCWEBSERVER_REGEX
    -DESP32C3_SUPERMINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
