<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rituals Diffuser</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">
                <svg viewBox="0 0 24 24" width="32" height="32"><path fill="currentColor" d="M12 2C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2 15h-4v-1h4v1zm0-2h-4v-1h4v1zm-1.5-3.59V14h-1v-2.59L9.67 9.59l.71-.71L12 10.5l1.62-1.62.71.71-1.83 1.82z"/></svg>
                <span>Rituals Diffuser</span>
            </div>
            <div class="status">
                <span class="status-item"><span id="wifi-dot" class="dot"></span>WiFi</span>
                <span class="status-item"><span id="mqtt-dot" class="dot"></span>MQTT</span>
            </div>
        </header>

        <!-- Update notification banner -->
        <div id="update-banner" class="update-banner hidden">
            <div class="update-content">
                <span class="update-icon">Update available!</span>
                <span id="update-version"></span>
            </div>
            <div class="update-actions">
                <span id="esp32-actions" class="hidden">
                    <button id="banner-install" class="btn-sm">Install</button>
                </span>
                <span id="esp8266-actions" class="hidden">
                    <a id="banner-github" href="#" target="_blank" class="btn-sm">Download</a>
                    <a href="/update.html" class="btn-sm">Upload</a>
                </span>
                <button id="banner-dismiss" class="btn-sm-ghost">Dismiss</button>
            </div>
        </div>

        <main>
            <section class="hero">
                <button id="power" class="power-btn">
                    <svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                </button>
                <div class="speed-ring" id="speed-ring">
                    <svg viewBox="0 0 120 120">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#6366f1"/>
                                <stop offset="100%" style="stop-color:#8b5cf6"/>
                            </linearGradient>
                        </defs>
                        <circle class="bg" cx="60" cy="60" r="54"/>
                        <circle class="progress" cx="60" cy="60" r="54" id="speed-circle"/>
                    </svg>
                    <div class="speed-text">
                        <span id="speed-val">50</span><small>%</small>
                    </div>
                </div>
                <input type="range" id="speed" min="0" max="100" value="50">
                <div class="rpm">RPM: <span id="rpm">0</span></div>
            </section>

            <section class="card">
                <h3>Timer</h3>
                <div class="timer-grid">
                    <button class="timer-btn" data-t="30">30m</button>
                    <button class="timer-btn" data-t="60">60m</button>
                    <button class="timer-btn" data-t="90">90m</button>
                    <button class="timer-btn" data-t="120">120m</button>
                    <button class="timer-btn active" data-t="0">âˆž</button>
                </div>
                <div class="remaining" id="remaining"></div>
            </section>

            <section class="card">
                <div class="row">
                    <h3>Interval Mode <span class="tooltip" title="Cycles the fan on/off at set intervals to conserve fragrance">?</span></h3>
                    <label class="switch"><input type="checkbox" id="interval"><span></span></label>
                </div>
                <div class="interval-cfg" id="interval-cfg">
                    <div class="field"><label>On <span class="tooltip" title="How long the fan runs during each cycle">?</span></label><input type="number" id="int-on" min="10" max="120" step="5" value="30"><span>s</span></div>
                    <div class="field"><label>Off <span class="tooltip" title="How long the fan pauses between cycles">?</span></label><input type="number" id="int-off" min="10" max="120" step="5" value="30"><span>s</span></div>
                    <button id="save-int" class="btn-sm">Save</button>
                </div>
            </section>

            <details class="card">
                <summary>WiFi Settings</summary>
                <form id="wifi-form">
                    <input type="text" id="w-ssid" placeholder="SSID" required>
                    <input type="password" id="w-pass" placeholder="Password">
                    <button type="submit" class="btn">Connect</button>
                </form>
                <div class="info">
                    <span>Network: <b id="cur-ssid">--</b></span>
                    <span>IP: <b id="cur-ip">--</b></span>
                </div>
            </details>

            <details class="card">
                <summary>MQTT Settings</summary>
                <form id="mqtt-form">
                    <div class="row-2">
                        <input type="text" id="m-host" placeholder="Host" required>
                        <input type="number" id="m-port" placeholder="Port" value="1883">
                    </div>
                    <input type="text" id="m-user" placeholder="Username">
                    <input type="password" id="m-pass" placeholder="Password">
                    <button type="submit" class="btn">Save</button>
                </form>
            </details>

            <details class="card">
                <summary>Night Mode</summary>
                <div class="row">
                    <span>Enable night mode</span>
                    <label class="switch"><input type="checkbox" id="night-enable"><span></span></label>
                </div>
                <div id="night-cfg" class="night-cfg">
                    <div class="row-2">
                        <div class="field-group">
                            <label>Start (hour)</label>
                            <input type="number" id="night-start" min="0" max="23" value="22">
                        </div>
                        <div class="field-group">
                            <label>End (hour)</label>
                            <input type="number" id="night-end" min="0" max="23" value="7">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>LED Brightness</label>
                        <input type="range" id="night-bright" min="0" max="100" value="10">
                        <span id="night-bright-val">10%</span>
                    </div>
                    <button id="save-night" class="btn">Save Night Mode</button>
                </div>
            </details>

            <details class="card">
                <summary>Hardware Diagnostics</summary>
                <div class="diag-section">
                    <h4>Pin Configuration</h4>
                    <div class="info">
                        <span>Platform: <b id="diag-platform">--</b></span>
                        <span>Fan PWM: <b>G<span id="diag-fan-pwm">--</span></b></span>
                        <span>Fan Tacho: <b>G<span id="diag-fan-tacho">--</span></b></span>
                        <span>LED: <b>G<span id="diag-led">--</span></b></span>
                        <span>Btn Front: <b>G<span id="diag-btn-front">--</span></b></span>
                        <span>Btn Rear: <b>G<span id="diag-btn-rear">--</span></b></span>
                    </div>
                </div>
                <div class="diag-section">
                    <h4>Fan Test</h4>
                    <div class="diag-status">Status: <span id="fan-status" class="dot"></span> <span id="fan-status-text">--</span></div>
                    <div class="diag-status">RPM: <b id="fan-rpm">0</b> | PWM: <b id="fan-pwm">0</b></div>
                    <div class="diag-btns">
                        <button class="btn-sm diag-fan" data-action="test">Test Cycle</button>
                        <button class="btn-sm diag-fan" data-action="on">On</button>
                        <button class="btn-sm diag-fan" data-action="off">Off</button>
                    </div>
                    <div class="field-group" style="margin-top:10px">
                        <label><span>Min PWM (current: <b id="min-pwm-val">0</b>) <span class="tooltip" title="Lowest PWM value where the fan starts spinning. Use Calibrate to auto-detect, or set manually (0-255)">?</span></span></label>
                        <div class="diag-btns">
                            <input type="number" id="min-pwm-input" min="0" max="255" value="0" style="width:60px">
                            <button class="btn-sm" id="set-min-btn">Set</button>
                            <button class="btn-sm diag-fan" data-action="calibrate">Calibrate</button>
                        </div>
                    </div>
                </div>
                <div class="diag-section">
                    <h4>LED Test</h4>
                    <div class="diag-status">Status: <span id="led-status" class="dot"></span> <span id="led-status-text">--</span></div>
                    <div class="diag-btns">
                        <button class="btn-sm diag-led" data-color="test">Test All</button>
                        <button class="btn-sm diag-led" data-color="red" style="background:#e74c3c">Red</button>
                        <button class="btn-sm diag-led" data-color="green" style="background:#27ae60">Green</button>
                        <button class="btn-sm diag-led" data-color="blue" style="background:#3498db">Blue</button>
                        <button class="btn-sm diag-led" data-color="reset">Reset</button>
                    </div>
                </div>
                <div class="diag-section">
                    <h4>Button Test</h4>
                    <div class="diag-status">
                        Front (G<span id="btn-front-pin">--</span>): <span id="btn-front-status" class="dot"></span> <span id="btn-front-text">Released</span>
                    </div>
                    <div class="diag-status">
                        Rear (G<span id="btn-rear-pin">--</span>): <span id="btn-rear-status" class="dot"></span> <span id="btn-rear-text">Released</span>
                    </div>
                    <small class="hint">Press buttons on device to test</small>
                </div>
            </details>

            <details class="card">
                <summary>Device Settings</summary>
                <form id="device-form">
                    <div class="field-group">
                        <label>Device Name <span class="tooltip" title="Name shown in Home Assistant and web interface">?</span></label>
                        <input type="text" id="device-name" placeholder="Rituals Diffuser" maxlength="31">
                    </div>
                    <button type="submit" class="btn">Save</button>
                </form>
            </details>

            <details class="card">
                <summary>Statistics</summary>
                <div class="info">
                    <span>Total runtime: <b id="total-runtime">--</b> hours</span>
                    <span>Session: <b id="session-runtime">--</b> min</span>
                </div>
            </details>

            <details class="card">
                <summary>Security</summary>
                <form id="pass-form">
                    <div class="field-group">
                        <label>OTA Password <small id="ota-status"></small></label>
                        <input type="password" id="p-ota" placeholder="New OTA password (min 8 chars)">
                    </div>
                    <div class="field-group">
                        <label>WiFi AP Password <small id="ap-status"></small></label>
                        <input type="password" id="p-ap" placeholder="New AP password (min 8 chars)">
                    </div>
                    <button type="submit" class="btn">Save Passwords</button>
                    <small class="hint">Device restart required after changing passwords</small>
                </form>
            </details>

            <details class="card" id="logs-section">
                <summary>System Logs</summary>
                <div class="logs-header">
                    <button id="refresh-logs" class="btn-sm">Refresh</button>
                    <button id="clear-logs" class="btn-sm danger">Clear</button>
                </div>
                <div id="logs-container" class="logs-container">
                    <div class="log-loading">Loading logs...</div>
                </div>
            </details>

            <details class="card" id="update-section">
                <summary>Software Updates</summary>
                <div class="update-status">
                    <div class="row">
                        <span>Current version:</span>
                        <b id="current-ver">--</b>
                    </div>
                    <div class="row">
                        <span>Latest version:</span>
                        <b id="latest-ver">--</b>
                    </div>
                    <div class="row">
                        <span>Status:</span>
                        <span id="update-state">Unknown</span>
                    </div>
                </div>
                <div class="update-progress hidden" id="update-progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="update-progress-bar"></div>
                    </div>
                    <span id="update-progress-text">0%</span>
                </div>
                <div class="update-buttons">
                    <button id="check-update" class="btn">Check for Updates</button>
                    <span id="install-section" class="hidden">
                        <button id="do-install" class="btn btn-success">Install Update</button>
                    </span>
                    <span id="manual-section" class="hidden">
                        <a id="download-link" href="#" target="_blank" class="btn">Download from GitHub</a>
                    </span>
                </div>
            </details>

            <details class="card">
                <summary>System</summary>
                <div class="info">
                    <span>MAC: <b id="mac">--</b></span>
                    <span>Signal: <b id="rssi">--</b> dBm</span>
                </div>
                <button id="reset" class="btn danger">Factory Reset</button>
            </details>
        </main>
        <footer>
            <a href="/update.html">Firmware Update</a>
            <a href="https://github.com/martijnrenkema/Rituals-diffuser" target="_blank" rel="noopener">GitHub</a>
            <span class="version" id="footer-version">v--</span>
        </footer>
    </div>
    <script src="script.js"></script>
</body>
</html>
